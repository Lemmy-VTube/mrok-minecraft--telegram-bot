#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะทะฐะฟััะบะฐ Minecraft Telegram Bot

set -e

echo "๐ ะะฐะฟััะบ Minecraft Telegram Bot..."

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต .env ัะฐะนะปะฐ
if [ ! -f ".env" ]; then
    echo "โ ะคะฐะนะป .env ะฝะต ะฝะฐะนะดะตะฝ!"
    echo "๐ ะกะบะพะฟะธััะนัะต .env.example ะฒ .env ะธ ะทะฐะฟะพะปะฝะธัะต ะฝะตะพะฑัะพะดะธะผัะต ะฟะฐัะฐะผะตััั:"
    echo "   cp .env.example .env"
    echo "   nano .env"
    exit 1
fi

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต ะพะฑัะทะฐัะตะปัะฝัั ะฟะตัะตะผะตะฝะฝัั
if ! grep -q "TOKEN_BOT=" .env || ! grep -q "ADMIN_ID=" .env; then
    echo "โ ะ ัะฐะนะปะต .env ะฝะต ะทะฐะฟะพะปะฝะตะฝั ะพะฑัะทะฐัะตะปัะฝัะต ะฟะฐัะฐะผะตััั TOKEN_BOT ะธ ADMIN_ID"
    exit 1
fi

# ะกะพะทะดะฐะตะผ ะดะธัะตะบัะพัะธั ะดะปั ะปะพะณะพะฒ
mkdir -p logs

# ะัะพะฒะตััะตะผ ะฟัะฐะฒะฐ ะดะพัััะฟะฐ ะบ ะดะธัะตะบัะพัะธะธ ัะตัะฒะตัะฐ
if [ ! -d "/root/projects/mrok-minecraft-server" ]; then
    echo "โ๏ธ  ะะธัะตะบัะพัะธั ัะตัะฒะตัะฐ ะฝะต ะฝะฐะนะดะตะฝะฐ: /root/projects/mrok-minecraft-server"
    echo "๐ ะะฑะฝะพะฒะธัะต ะฟััั ะฒ docker-compose.yml ะตัะปะธ ัะตัะฒะตั ะฝะฐัะพะดะธััั ะฒ ะดััะณะพะผ ะผะตััะต"
fi

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะน ะบะพะฝัะตะนะฝะตั ะตัะปะธ ะพะฝ ะทะฐะฟััะตะฝ
echo "๐ ะััะฐะฝะพะฒะบะฐ ัััะตััะฒัััะตะณะพ ะบะพะฝัะตะนะฝะตัะฐ..."
docker-compose down 2>/dev/null || true

# ะกะพะฑะธัะฐะตะผ ะพะฑัะฐะท ะธ ะทะฐะฟััะบะฐะตะผ
echo "๐จ ะกะฑะพัะบะฐ ะธ ะทะฐะฟััะบ..."
docker-compose up -d --build

# ะะพะบะฐะทัะฒะฐะตะผ ััะฐััั
echo "โ ะะพั ะทะฐะฟััะตะฝ!"
echo ""
echo "๐ ะกัะฐััั ะบะพะฝัะตะนะฝะตัะฐ:"
docker-compose ps

echo ""
echo "๐ ะะปั ะฟัะพัะผะพััะฐ ะปะพะณะพะฒ:"
echo "   docker-compose logs -f"
echo ""
echo "๐ ะะปั ะพััะฐะฝะพะฒะบะธ:"
echo "   ./stop.sh"